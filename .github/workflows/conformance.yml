name: Conformance Tests

# This workflow runs conformance tests in parallel to reduce CI time

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:  # Allow manual triggering

# Set permissions for GITHUB_TOKEN
# Need write permissions to commit conformance report
permissions:
  contents: write

jobs:
  # Run standard library and integration tests first (fast, basic checks)
  basic-tests:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Rust toolchain
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: stable
      
      - name: Run standard library tests
        run: cargo test --lib
      
      - name: Run integration tests
        run: cargo test --test integration_test --test test_real_files
  
  # Setup test suites once for all conformance jobs
  setup-test-suites:
    runs-on: ubuntu-latest
    
    steps:
      - name: Cache test suites
        id: cache-test-suites
        uses: actions/cache@v4
        with:
          path: test_suites
          key: ${{ runner.os }}-test-suites-${{ hashFiles('.github/workflows/conformance.yml') }}
          restore-keys: |
            ${{ runner.os }}-test-suites-
      
      - name: Clone 3MF test suites
        if: steps.cache-test-suites.outputs.cache-hit != 'true'
        run: |
          git clone --depth 1 https://github.com/3MFConsortium/test_suites.git
      
      - name: Upload test suites artifact
        uses: actions/upload-artifact@v4
        with:
          name: test-suites
          path: test_suites/
          retention-days: 1
  
  # Run each conformance suite in parallel
  conformance:
    runs-on: ubuntu-latest
    needs: [basic-tests, setup-test-suites]
    
    strategy:
      fail-fast: false
      matrix:
        suite:
          # Suites 1-8 use lowercase directory names
          - name: suite1_core_slice_prod
            dir: suite1_core_slice_prod
            pos_dir: positive_test_cases
            neg_dir: negative_test_cases
          - name: suite2_core_prod_matl
            dir: suite2_core_prod_matl
            pos_dir: positive_test_cases
            neg_dir: negative_test_cases
          - name: suite3_core
            dir: suite3_core
            pos_dir: positive_test_cases
            neg_dir: negative_test_cases
          - name: suite4_core_slice
            dir: suite4_core_slice
            pos_dir: positive_test_cases
            neg_dir: negative_test_cases
          - name: suite5_core_prod
            dir: suite5_core_prod
            pos_dir: positive_test_cases
            neg_dir: negative_test_cases
          - name: suite6_core_matl
            dir: suite6_core_matl
            pos_dir: positive_test_cases
            neg_dir: negative_test_cases
          - name: suite7_beam
            dir: suite7_beam
            pos_dir: positive_test_cases
            neg_dir: negative_test_cases
          - name: suite8_secure
            dir: suite8_secure
            pos_dir: positive_test_cases
            neg_dir: negative_test_cases
          # Suites 9-11 use title case with spaces (as defined in upstream test suite repo)
          - name: suite9_core_ext
            dir: suite9_core_ext
            pos_dir: Positive Tests
            neg_dir: Negative Tests
          - name: suite10_boolean
            dir: suite10_boolean
            pos_dir: Positive Tests
            neg_dir: Negative Tests
          - name: suite11_displacement
            dir: suite11_Displacement
            pos_dir: Positive Tests
            neg_dir: Negative Tests
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Rust toolchain
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: stable
      
      - name: Download test suites artifact
        uses: actions/download-artifact@v4
        with:
          name: test-suites
          path: test_suites
      
      - name: Run conformance tests for ${{ matrix.suite.name }}
        id: run-tests
        run: |
          echo "Testing suite: ${{ matrix.suite.name }}"
          cargo test --test conformance_tests ${{ matrix.suite.name }} -- --nocapture
      
      - name: Generate suite report
        if: always()
        run: |
          echo "# ${{ matrix.suite.name }} Results" > ${{ matrix.suite.name }}-results.md
          echo "Exit code from tests: ${{ steps.run-tests.outcome }}" >> ${{ matrix.suite.name }}-results.md
      
      - name: Upload suite report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: conformance-report-${{ matrix.suite.name }}
          path: ${{ matrix.suite.name }}-results.md
          retention-days: 30
  
  # Generate overall summary after all suites complete
  conformance-summary:
    runs-on: ubuntu-latest
    needs: [conformance, setup-test-suites]
    if: always()
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Rust toolchain
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: stable
      
      - name: Download test suites artifact
        uses: actions/download-artifact@v4
        with:
          name: test-suites
          path: test_suites
      
      - name: Generate overall conformance summary
        run: |
          echo "# Conformance Test Results" > conformance-summary.md
          echo "" >> conformance-summary.md
          echo "## Overall Summary" >> conformance-summary.md
          cargo test --test conformance_tests summary -- --ignored --nocapture 2>&1 | tee -a conformance-summary.md
        continue-on-error: true
      
      - name: Download all suite reports
        uses: actions/download-artifact@v4.1.3
        with:
          pattern: conformance-report-*
          path: suite-reports
      
      - name: Generate CONFORMANCE_REPORT.md
        run: |
          echo "Generating conformance report..."
          ./generate_conformance_report.sh
      
      - name: Commit and push conformance report
        # Only commit on push to main/develop, not on PRs
        if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop')
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add CONFORMANCE_REPORT.md
          # Only commit if there are changes
          if ! git diff --cached --quiet; then
            git commit -m "Update conformance report [skip ci]"
            # Push with error handling
            if git push; then
              echo "✅ Conformance report updated and committed"
            else
              echo "❌ Failed to push conformance report"
              echo "This may be due to concurrent changes or permission issues"
              exit 1
            fi
          else
            echo "ℹ️ No changes to conformance report"
          fi
      
      - name: Upload combined conformance report
        uses: actions/upload-artifact@v4
        with:
          name: conformance-report-combined
          path: |
            conformance-summary.md
            suite-reports/
            CONFORMANCE_REPORT.md
          retention-days: 30

